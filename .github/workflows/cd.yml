name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., sha-abc1234)'
        required: true
        type: string
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - master

env:
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}
  K8S_NAMESPACE: ${{ vars.K8S_NAMESPACE || 'default' }}

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --name ${{ secrets.EKS_CLUSTER_NAME }} \
            --region ${{ secrets.AWS_REGION }}

      - name: Determine image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            # Extract SHA from CI workflow run
            SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
            echo "tag=sha-$SHA" >> $GITHUB_OUTPUT
          fi
          echo "Deploying image tag: $(cat $GITHUB_OUTPUT | grep tag | cut -d= -f2)"

      - name: Replace image tag in deployment
        run: |
          sed -i "s|DOCKERHUB_USERNAME|${{ vars.DOCKERHUB_USERNAME }}|g" k8s/deployment.yml
          sed -i "s|IMAGE_TAG|${{ steps.image-tag.outputs.tag }}|g" k8s/deployment.yml
          echo "Updated deployment manifest:"
          cat k8s/deployment.yml

      - name: Create namespace if not exists
        run: |
          kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          echo "ðŸš€ Deploying application to EKS..."
          kubectl apply -f k8s/deployment.yml -n ${{ env.K8S_NAMESPACE }}
          kubectl apply -f k8s/service.yml -n ${{ env.K8S_NAMESPACE }}

      - name: Wait for rollout
        run: |
          echo "â³ Waiting for deployment rollout..."
          kubectl rollout status deployment/basic-springboot-app -n ${{ env.K8S_NAMESPACE }} --timeout=5m

      - name: Verify deployment
        run: |
          echo "âœ… Verifying deployment..."
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=basic-springboot-app
          kubectl get svc -n ${{ env.K8S_NAMESPACE }} -l app=basic-springboot-app

      - name: Setup port-forward for DAST
        run: |
          echo "ðŸ”Œ Setting up port-forward for DAST scan..."
          kubectl port-forward -n ${{ env.K8S_NAMESPACE }} svc/basic-springboot-app 8080:80 &
          sleep 5
          echo "PORT_FORWARD_PID=$!" >> $GITHUB_ENV

      - name: Wait for service to be ready
        run: |
          echo "â³ Waiting for service to be ready..."
          for i in {1..30}; do
            if curl -f http://localhost:8080/greetings > /dev/null 2>&1; then
              echo "âœ… Service is ready"
              break
            fi
            echo "Attempt $i/30: Waiting for service..."
            sleep 2
          done

      - name: DAST - OWASP ZAP Baseline Scan
        run: |
          echo "ðŸ”’ Running OWASP ZAP baseline scan..."
          docker run --rm \
            --network host \
            -v $(pwd):/zap/wrk/:rw \
            -t owasp/zap2docker-stable zap-baseline.py \
            -t http://127.0.0.1:8080/greetings \
            -J zap-report.json \
            -r zap-report.html \
            -g gen.conf \
            || true  # Continue even if scan finds issues
          
          echo "ðŸ“Š ZAP Scan Summary:"
          if [ -f zap-report.json ]; then
            cat zap-report.json | jq '.site[] | {name: .name, alerts: [.alerts[] | {risk: .risk, name: .name}]}' || true
          fi

      - name: Upload ZAP report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap-report.json
            zap-report.html
          retention-days: 30

      - name: Cleanup port-forward
        if: always()
        run: |
          if [ ! -z "$PORT_FORWARD_PID" ]; then
            kill $PORT_FORWARD_PID || true
          fi
          pkill -f "kubectl port-forward" || true

      - name: Deployment Summary
        if: always()
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployment: Application deployed to EKS" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Image Tag: ${{ steps.image-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Rollout: Deployment rollout completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… DAST: OWASP ZAP baseline scan completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- Cluster: ${{ secrets.EKS_CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- Namespace: ${{ env.K8S_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
          echo "- Image: ${{ vars.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.image-tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
