name: CI Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Dmaven.repo.local=.m2/repository'
  IMAGE_NAME: ${{ vars.IMAGE_NAME }}

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    env:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for CodeQL

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Linting - Checkstyle
        run: |
          echo "ðŸ” Running Checkstyle to enforce coding standards..."
          mvn checkstyle:check
        continue-on-error: false

      - name: SAST - Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: java
          queries: security-extended,security-and-quality

      - name: SAST - Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: SAST - Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          upload: true

      - name: SCA - OWASP Dependency Check
        if: env.NVD_API_KEY != ''
        run: |
          echo "ðŸ”’ Scanning dependencies for known vulnerabilities..."
          mvn org.owasp:dependency-check-maven:check \
            -Dformat=SARIF \
            -DoutputDirectory=target \
            -DoutputName=dependency-check-report \
            -DnvdApiKey=${{ env.NVD_API_KEY }}

      - name: SCA - Upload Dependency Check SARIF
        if: always() && hashFiles('target/dependency-check-report.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: target/dependency-check-report.sarif

      - name: Unit Tests
        run: |
          echo "ðŸ§ª Running unit tests..."
          mvn test

      - name: Build Application
        run: |
          echo "ðŸ”¨ Building application..."
          mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ vars.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=sha-,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Image Scan - Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true

      - name: Image Scan - Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ vars.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy image scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-image-results.sarif') != ''
        with:
          sarif_file: 'trivy-image-results.sarif'
        continue-on-error: true

      - name: Runtime Test - Container smoke test
        run: |
          echo "ðŸš€ Testing container runtime behavior..."
          IMAGE_TAG=${{ steps.meta.outputs.version }}
          CONTAINER_NAME=test-container-$${RANDOM}
          
          # Run container in background
          docker run -d --name $CONTAINER_NAME -p 8080:8080 \
            ${{ vars.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG
          
          # Wait for container to be ready
          echo "Waiting for container to start..."
          sleep 10
          
          # Test health endpoint
          for i in {1..30}; do
            if curl -f http://localhost:8080/greetings > /dev/null 2>&1; then
              echo "âœ… Container is responding"
              break
            fi
            echo "Attempt $i/30: Waiting for container..."
            sleep 2
          done
          
          # Verify response
          RESPONSE=$(curl -s http://localhost:8080/greetings)
          echo "Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "Hello from Spring Boot"; then
            echo "âœ… Runtime test passed - endpoint returns expected content"
          else
            echo "âŒ Runtime test failed - unexpected response"
            exit 1
          fi
          
          # Cleanup
          docker stop $CONTAINER_NAME
          docker rm $CONTAINER_NAME

      - name: Push Docker image to DockerHub
        if: success()
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        if: always()
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Code Quality: Checkstyle passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Security: CodeQL SAST completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependencies: OWASP Dependency Check completed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Tests: Unit tests passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build: Application built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Container: Image built and scanned" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Runtime: Container smoke test passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Registry: Image pushed to DockerHub" >> $GITHUB_STEP_SUMMARY
